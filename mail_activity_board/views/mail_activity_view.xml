<?xml version="1.0" encoding="utf-8" ?>
<odoo>
<!--
    VIEWS
-->


    <!-- FORM VIEW -->
    <record id="mail_activity_view_form_board" model="ir.ui.view">
        <field name="name">mail.activity.form.boards.sdi</field>
        <field name="model">mail.activity</field>
        <field name="priority">30</field>
        <field name="arch" type="xml">
            <form string="Activity Form" create="false" edit="false" delete="false">
                <sheet string="Activity">
                    <group invisible="1">
                        <field name="activity_category" invisible="1" />
                        <field name="res_model" invisible="1"/>
                        <field name="res_model_id" invisible="1"/>
                        <field name="res_id" invisible="1"/>
                        <field name="previous_activity_type_id"/>
                        <field name="has_recommended_activities"/>
                    </group>
                    <group attrs="{'invisible': [('has_recommended_activities','=',False)]}">
                        <div>
                            <p><strong>Recommended Activities</strong></p>
                            <field name="recommended_activity_type_id" widget="radio"
                                domain="[('previous_type_ids', '=', previous_activity_type_id)]"
                                options="{'horizontal':true}"
                                nolabel="1"/>
                        </div>
                    </group>
                    <group>
                        <group>
                            <field name="activity_type_id" required="1" options="{'no_create': True, 'no_open': True}"/>
                            <field name="res_model_id_name"/>

                            <button name="open_origin" type="object" class="centre oe_link" nolabel="1">
                                <field name="res_name"><field name="res_model_id_name"/></field>
                            </button>

                            <field name="calendar_event_id" invisible="1"/>
                            <field name="create_date" invisible="1"/>
                            <field name="summary" placeholder="e.g. Discuss proposal"/>
                        </group>
                        <group>
                            <field name="date_deadline"
                                   attrs="{'invisible': [('activity_category', '=', 'meeting')]}"/>
                            <field name="calendar_event_id_start" string="Start meeting"
                                   attrs="{'invisible': [('calendar_event_id','=', False)], 'readonly': 1}"/>
                            <field name="duration" widget="float_time"
                                   attrs="{'invisible': ['|',('duration', '=', False),
                                   ('calendar_event_id','=', False)], 'readonly': 1}"/>
                            <field name="user_id"/>
                            <field name="calendar_event_id_partner_ids" widget="many2many_tags"
                                   attrs="{'invisible': [('calendar_event_id','=', False)], 'readonly': 1}"/>
                        </group>
                    </group>
                    <field name="note" placeholder="Log a note..."/>

                </sheet>
            </form>
        </field>
    </record>


    <!-- TREE VIEW -->
    <record id="mail_activity_view_tree" model="ir.ui.view">
        <field name="name">boards.activities.tree</field>
        <field name="model">mail.activity</field>
        <field name="inherit_id" ref="mail.mail_activity_view_tree"/>
        <field name="domain"></field>
        <field name="arch" type="xml">

            <xpath expr="//tree" position="attributes">

                <attribute name="default_order"></attribute>

                <attribute name="decoration-danger">(date_deadline &lt; current_date)</attribute>
                <attribute name="decoration-warning">(date_deadline == current_date)</attribute>
                <attribute name="decoration-success">(date_deadline &gt; current_date) </attribute>

            </xpath>

        </field>
    </record>



    <!-- KANBAN VIEW -->
     <record id="mail_activity_view_kanban" model="ir.ui.view">
         <field name="name">sdi.boards.activities.kanban</field>
         <field name="model">mail.activity</field>
         <field name="priority" eval="10"/>
         <field name="context">{}</field>
         <field name="arch" type="xml">
            <kanban default_group_by="activity_type_id" class="_kanban_small_column o_opportunity_kanban" create="0" _order="date_deadline"
                    group_create="false" group_delete="false" group_edit="false">
                <field name="user_id"/>
                <field name="res_id"/>
                <field name="res_name"/>
                <field name="res_model"/>
                <field name="summary"/>
                <field name="date_deadline"/>
                <field name="state"/>
                <field name="icon"/>
                <field name="activity_type_id"/>
                <field name="activity_category"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="#{kanban_color(record.state)} oe_kanban_content oe_kanban_global_click">
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <span t-attf-class="fa #{record.icon}" />
                                    <span t-attf-class="o_activity_color_#{state}"><field name="activity_category" /> </span>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <em>due on: </em><span t-attf-class="o_activity_color_#{state}"><field name="date_deadline" /> </span>
                                    <strong>
                                        <t t-esc="activity_type_id" />
                                    </strong>
                                </div>
                            </div>
                            <strong><span t-attf-class="o_activity_date o_activity_color_#{record.state}"><t t-esc="record.label_delay" /></span></strong>
                            <div>
                                <strong class="o_kanban_record_subtitle"><field name="res_name"/></strong>
                            </div>
                            <div>
                                <span class="o_kanban_record_subtitle"><field name="user_id"/></span>
                            </div>
                            <field name="calendar_event_id_start"/>
                        </div>
                    </t>
                </templates>
            </kanban>
         </field>
    </record>


    <!-- SEARCH VIEW -->
    <record id="mail_activity_view_search" model="ir.ui.view">
        <field name="name">search.activity.view.calendar.inherit.activities_board</field>
        <field name="model">mail.activity</field>
        <field name="inherit_id" ref="mail.mail_activity_view_search"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr='//field[@name="res_model_id"]' position='before'>
                <field name="user_id"/>
                <field name="res_name" string="Origin (opportunity/customer)"/>
            </xpath>

            <xpath expr='//filter[@name="activities_my"]' position='after'>
                <filter string="Act. next month" name="activities_month"
                        domain="[('date_deadline', '&lt;', (context_today()+datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"
                        help="Show activities which date deadline is before than 1 month."/>
                <filter string="Act. next 6 months" name="activities_6_month"
                        domain="[('date_deadline', '&lt;', (context_today()+datetime.timedelta(days=180)).strftime('%Y-%m-%d'))]"
                        help="Show activities which date deadline is before than 6 months."/>
                <separator/>
            </xpath>

            <xpath expr='//search/group' position='inside'>
                <filter string="User" domain="[]" groups="sales_team.group_sale_salesman_all_leads" context="{'group_by':'user_id'}"/>
                <filter string="Origin" context="{'group_by': 'res_model_id'}"/>
            </xpath>

        </field>
    </record>


<!--
    ACTION
-->

    <record model="ir.actions.act_window" id="open_boards_activities_form_tree">
        <field name="name">ACTIVITIES</field>
        <field name="res_model">mail.activity</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="groups_id" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="view_ids"
                   eval="[(5, 0, 0),
                          (0, 0, {'view_mode': 'tree', 'view_id': ref('mail_activity_view_tree')}),
                          (0, 0, {'view_mode': 'form', 'view_id': ref('mail_activity_view_form_board')}),
                          (0, 0, {'view_mode': 'kanban', 'view_id': ref('mail_activity_view_kanban')}),
                          (0, 0, {'view_mode': 'calendar'}),
                          (0, 0, {'view_mode': 'pivot'}),
                          (0, 0, {'view_mode': 'graph'})]"/>
        <field name="search_view_id" ref="mail_activity_view_search"/>
    </record>

<!--
Action
-->

    <record id="action_your_activities" model="ir.actions.server">
        <field name="name">Boards: My Activities</field>
        <field name="model_id" ref="model_mail_activity"/>
        <field name="state">code</field>
        <field name="code">action = model.action_your_activities()</field>
    </record>

<!--
Menu
-->

    <menuitem
            id="sdi_board_menu_activities"
            name="Activities"
            parent="base.menu_board_root"
            action="action_your_activities"
            sequence="1"/>

</odoo>
